<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222"/>


  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"/>



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-flash.min.css?v=1.0.2"/>





  <meta http-equiv="Cache-Control" content="no-transform"/>
  <meta http-equiv="Cache-Control" content="no-siteapp"/>
















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext"/>
  






<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"/>

<link rel="stylesheet" href="/css/main.css?v=6.7.0"/>


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=6.7.0">


  <link rel="mask-icon" href="/images/favicon.ico?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.7.0',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":true,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="系统设计读书笔记。祝我好运。">
<meta name="keywords" content="interview,system,design">
<meta property="og:type" content="article">
<meta property="og:title" content="Design Data Intensive Applications读书笔记">
<meta property="og:url" content="https://bobbyliujb.github.io/2020/01/15/designing_data_intensive_app/index.html">
<meta property="og:site_name" content="Bob&#39;s Blog">
<meta property="og:description" content="系统设计读书笔记。祝我好运。">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-02-11T11:59:27.435Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Design Data Intensive Applications读书笔记">
<meta name="twitter:description" content="系统设计读书笔记。祝我好运。">






  <link rel="canonical" href="https://bobbyliujb.github.io/2020/01/15/designing_data_intensive_app/"/>



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Design Data Intensive Applications读书笔记 | Bob's Blog</title>
  




  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-118868735-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-118868735-1');
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Bob's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br/>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br/>Tags<span class="badge">49</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br/>Categories<span class="badge">4</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br/>Archives<span class="badge">47</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://bobbyliujb.github.io/2020/01/15/designing_data_intensive_app/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Bob"/>
      <meta itemprop="description" content="I'm a Software Engineer!"/>
      <meta itemprop="image" content="/images/avatar.jpg"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bob's Blog"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Design Data Intensive Applications读书笔记

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-01-14 21:08:26" itemprop="dateCreated datePublished" datetime="2020-01-14T21:08:26-08:00">2020-01-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-02-11 03:59:27" itemprop="dateModified" datetime="2020-02-11T03:59:27-08:00">2020-02-11</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/15/designing_data_intensive_app/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/01/15/designing_data_intensive_app/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2020/01/15/designing_data_intensive_app/" class="leancloud_visitors" data-flag-title="Design Data Intensive Applications读书笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views: </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">14k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">14 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>系统设计读书笔记。祝我好运。<br><a id="more"></a></p>
<h2 id="Chapter-1-Relable-Scalable-and-Maintainable"><a href="#Chapter-1-Relable-Scalable-and-Maintainable" class="headerlink" title="Chapter 1: Relable, Scalable and Maintainable"></a>Chapter 1: Relable, Scalable and Maintainable</h2><h3 id="Reliability"><a href="#Reliability" class="headerlink" title="Reliability"></a>Reliability</h3><p> 系统能持续正常工作，即便遇到hardware/software faults甚至human errors.<br> fault: 系统中的一个component deviated from its spec.<br> failure: system as a whole stops providing required service.<br> 由于出现fault的几率不可能为0，因此倾向于设计fault-tolerant而不是fault-preventing的系统。</p>
<h4 id="Hardware-Faults"><a href="#Hardware-Faults" class="headerlink" title="Hardware Faults"></a>Hardware Faults</h4><ul>
<li>计算机系统中的硬盘、内存、power grid等等零件都可能出问题，这可以通过redundancy来减少整个系统宕机的概率。</li>
<li>随着数据量增加，增加备份也无法解决，就需要考虑如何在某个机器宕机的情况下通过软件调度来防止整个服务崩溃。</li>
</ul>
<h4 id="Software-Faults"><a href="#Software-Faults" class="headerlink" title="Software Faults"></a>Software Faults</h4><ul>
<li>软件bug通常隐藏很深，直到某种特殊情况出现触发了bug。</li>
<li>没有快速的解决办法，只能在实现的时候多考虑assumptions和interactions、写更全面的测试、process isolation、crash and auto-restart、持续measure/monitor/anlayze behaviors in production.</li>
</ul>
<h4 id="Human-Errors"><a href="#Human-Errors" class="headerlink" title="Human Errors"></a>Human Errors</h4><ul>
<li>用户总是不可靠的，operator的不当操作占系统崩溃的75%～90%。</li>
<li>在设计时就要多考虑人为因素，让他们自然地do the right thing, minimize opportunities for error; 提供sandbox让他们熟悉使用方法，随意犯错而不会影响production; 全面测试unit/integration/manual; 假设有human error提供快速recovery的机制; 设置detailed and clear monitoring.</li>
</ul>
<h3 id="Scalability"><a href="#Scalability" class="headerlink" title="Scalability"></a>Scalability</h3><p> 系统不见得可以一致reliable，例如随着数据量暴增，系统需要cope with increased load.</p>
<h4 id="如何衡量Load"><a href="#如何衡量Load" class="headerlink" title="如何衡量Load"></a>如何衡量Load</h4><ul>
<li>需要根据系统特性很简洁地描述。服务器的RPS? 数据库的读写比例? 用户同时在线数? 缓存的hit rate?</li>
<li>Twitter例子<ul>
<li>需求：实现用户发推(max 12k RPS)和看个人timeline(300k RPS).</li>
<li>挑战：如何快速为用户提供timeline。直接从数据库读其实也就是join，但是请求多的话DB无法handle，因此可以考虑为每个用户维护timeline的cache，只是发推的时候就需要更新对应用户的cache了。由于发推的RPS远小于读，cache的方法对读更有优势，但是对于follower众多的大号，发推需要更新的cache可能非常多，因此可以考虑针对这种大号直接写入DB，在timeline单独从DB读大号的推。</li>
</ul>
</li>
</ul>
<h4 id="如何衡量Performance"><a href="#如何衡量Performance" class="headerlink" title="如何衡量Performance"></a>如何衡量Performance</h4><ul>
<li>两个问题：维持当前系统软硬件不变，load可以提高到多少？为了提供某种load和相应的performance，需要增加多少resources?</li>
<li>Throughput: 单位时间内处理的records数量，或处理一定规模数据所需要的时间；</li>
<li>Response time: 网络延迟 + queuing + service time; 虽然用起来基本是同义词，但Latency特制其中的awaiting time.</li>
<li>Percentile: 响应时间如果直接数学平均，无法反映大致有多少请求受到影响。p95, p99, p999表示有95%, 99%, 99.9%的请求的响应时间快于某个值。</li>
<li>Tail latencies: outliers的响应时间有时也很重要，对于亚麻，大客户请求的数据量大，响应时间也就更长，不能不关注。</li>
<li>SLO/SLA: Service Level Objective/Agreements, 用percentile来判断系统是否up。</li>
<li>Load generating: 一定要independent of response time才能模拟真实情况，不能等到收到响应才轰下一个请求。</li>
</ul>
<h3 id="Maintainability"><a href="#Maintainability" class="headerlink" title="Maintainability"></a>Maintainability</h3><p> 软件开发本身开销不算最大，日后的维护、升级、迁移是大头。</p>
<h4 id="Operability"><a href="#Operability" class="headerlink" title="Operability"></a>Operability</h4><p> 保证operation组能让系统保持运行.</p>
<ul>
<li>高质量的monitoring</li>
<li>适当的logging来track down出问题（结果不对或者速度太慢）的根源</li>
<li>保证系统能升级，尤其是security patches.</li>
<li>正确的configuration</li>
<li>开发时遵循best practice</li>
</ul>
<h4 id="Simplicity"><a href="#Simplicity" class="headerlink" title="Simplicity"></a>Simplicity</h4><p> 保证代码简介，让新加入的码农也能理解代码。一个很有效的方法是abstraction，用high-level的类来描述统一的行为。</p>
<ul>
<li>防止explosion of the state space</li>
<li>让系统中的modules尽量decouple，减少dependencies</li>
<li>保证一致的naming</li>
<li>减少短视的hacks</li>
</ul>
<h4 id="Evolvability"><a href="#Evolvability" class="headerlink" title="Evolvability"></a>Evolvability</h4><p> 方便后续rafactor、加入新feature，与前面的simplicity息息相关。</p>
<ul>
<li>Agile working patterns比较方便change</li>
<li>TDD: test-driven development</li>
</ul>
<h2 id="Chapter-2-Data-Models-and-Query-Languages"><a href="#Chapter-2-Data-Models-and-Query-Languages" class="headerlink" title="Chapter 2: Data Models and Query Languages"></a>Chapter 2: Data Models and Query Languages</h2><p> 分层式系统中，每一层都隐藏下层的complexity，向上层提供clean data model。</p>
<h3 id="Relational-Model-v-s-Document-Model"><a href="#Relational-Model-v-s-Document-Model" class="headerlink" title="Relational Model v.s. Document Model"></a>Relational Model v.s. Document Model</h3><ul>
<li>relational有严格的schema，且方便处理transactional process.</li>
<li>NoSQL(Not only SQL)对于大数据、write heavy的场景更具有scalability，且可定制query<ul>
<li>schema flexibility</li>
<li>better performance due to locality</li>
<li>closer to the data structure in the application code level</li>
</ul>
</li>
<li>Object-Relational Mismatch: 在代码中和在数据库中的model并不是一致的，尽管有ORM帮忙转换，但本质上还是无法保证一一对应。例如领英中一个人物毕业的学校、就职的公司通常都会有另外的table来存，再通过各种join来取，而不是直接存在用户table里。</li>
<li>Normalization: 在relationalDB中通常用ID来定位records，是因为它只在数据库中有意义，而对人类有意义的内容存在table中，防止了存储重复信息到每一行中。此外用ID而不是plain-text还可以防止ambiguity，提高update的容易程度，更好地localization，更方便搜索等。</li>
<li>Many-to-One: Normalization需要有多个entity归属于同一个category的情况才值得normalize，否则就还是像document一样save nested records within their parent record.</li>
</ul>
<h4 id="SQL-NoSQL的优势劣势"><a href="#SQL-NoSQL的优势劣势" class="headerlink" title="SQL/NoSQL的优势劣势"></a>SQL/NoSQL的优势劣势</h4><ul>
<li>若系统中的数据本身就有类似document的一对多结构，比如a tree of one-to-many &amp;&amp; the tree is loaded at once，或者records之间没有关联，那么用Document DB就好，relational需要shredding，即把数据打碎存在不同的table中。</li>
<li>若数据是interconnected, many-to-many，那还是relational自带的join比较方便管理数据之间的关系，强行用document还需要自己模拟join的代码（多次query）</li>
<li>Schema flexibility: 准确地说是schema-on-read(结构是implicit的，只有读取的时候才会interpret)；而relational则是schema-on-write（explicit structure, 数据库会确保存入时符合格式）。当需要改变data format的时候，schema-less只要在代码层面加上针对新、旧数据读取的判断代码即可，而relational就需要migration进行ALTER（通常几ms就完成，除了mysql会复制所有数据）。此外，如果存储对象中有很多种类的数据，或者数据的结构时收外部系统控制的，这时规定schema的话hurt more than it helps.</li>
<li>Data Locality: document存储通常会直接读取整个block，如果确实需要这么多数据（如渲染网页）那么就有locality的优势，relational需要在各个table间收集再返回整个block（虽然Google’s Spanner DB也可以一次读一个block）。但document的缺陷是写入时需要对整个block重写，因此要尽量避免增加row size，在不改变encoded size of a document的情况下修改可以in-place完成。</li>
<li>Convergence: relational DB逐渐支持存储JSON blob，document DB也逐渐支持join操作，两者正在融合各自的优势，代码层面就可以根据应用场景选择代码实现。</li>
</ul>
<h3 id="Query-Language-for-Data"><a href="#Query-Language-for-Data" class="headerlink" title="Query Language for Data"></a>Query Language for Data</h3><ul>
<li>Imperative: 按照一定顺序执行给定操作，如代码中的for-loop。</li>
<li>Declarative: SQL只给定所需data的pattern（取的条件和返回的顺序等）。更简洁且隐藏了底层的优化，且支持并行计算。</li>
<li>CSS selector就是个declarative例子，不需要javascript循环查找特定的元素。</li>
<li>Map-Reduce Query: map和reduce两个纯粹的function实现query，介于imperative和declarative之间（需要写函数，支持并行）</li>
</ul>
<h3 id="Graph-Like-Data-Models"><a href="#Graph-Like-Data-Models" class="headerlink" title="Graph-Like Data Models"></a>Graph-Like Data Models</h3><ul>
<li>如果many-to-many关系很强，需要考虑用graph存放数据。</li>
<li>图由vertices和edges组成。vertices并不一定是相同类型的东西，例如fb中每个节点可以是用户/评论/登陆等事件。</li>
<li>若用relational DB表示图，需要两个表：一个存放vertices（含id和属性键值对），一个存放边（含id、始终点、label、属性键值对）。</li>
<li>任何vertex都可以连接到任何vertex；给定任何vertex，可以知道输入/输出的边，从而遍历整个图（双向）；合理使用label可以将大量信息存在一个图中。</li>
</ul>
<h2 id="Chapter-3-Storage-and-Retrieval"><a href="#Chapter-3-Storage-and-Retrieval" class="headerlink" title="Chapter 3: Storage and Retrieval"></a>Chapter 3: Storage and Retrieval</h2><p> 虽然我们并不会实现数据存储引擎，但有必要了解底层具体实现，以选择更适合应用（如analytics为主还是transactinal workload为主）的引擎。</p>
<h3 id="Data-Structures-in-Relational-DB"><a href="#Data-Structures-in-Relational-DB" class="headerlink" title="Data Structures in Relational DB"></a>Data Structures in Relational DB</h3><p> 主流存储引擎分为log-structured和page-oriented。log-strutured底层实现其实就是log（append-only sequence of records），涉及concurrency control, reclaiming disk space, hanling errors, etc. log的特点是写入很快，但查找如果不加优化就是O(N)的，因此需要开发者根据query的pattern加上合适的index提升查找速度。</p>
<h4 id="Hash-Indexes"><a href="#Hash-Indexes" class="headerlink" title="Hash Indexes"></a>Hash Indexes</h4><ul>
<li>假设存储的是key-value型的数据，在内存中维护一个hashmap，每次写入数据时往hashmap里放key和对应在log文件中的byte offset方便查找即可。注意这个log只能append，因此每次都无脑地往hashmap里更新key-offset即可。</li>
<li>为了防止log过大，可以用segment的方法拆分到不同file中，再定时执行compaction只保留最末的key并merge。</li>
<li>删除key则需要一个特殊的标识tombstone，这样在后续的merge中对应的key就会被删。</li>
<li>crash recovery: 内存一崩就全没，因此可以dump到硬盘上，崩后重新读入内存。由于只允许append，因此不需要检测更新到一半崩溃的问题。</li>
<li>partially written data: Bitcask files含有checksum保证文件准确完整。</li>
<li>concurrency control: 既然只允许append，就只允许一个writer就好了。</li>
<li>不足：a) index必须全部容纳到内存中，因此key的数量有限。 b) Range query并不高效，需要现在hashmap中作一个range查找再去file中读取。</li>
</ul>
<h4 id="Sorted-String-Tables-and-Log-Structured-Merge-Trees"><a href="#Sorted-String-Tables-and-Log-Structured-Merge-Trees" class="headerlink" title="Sorted String Tables and Log-Structured Merge-Trees"></a>Sorted String Tables and Log-Structured Merge-Trees</h4><ul>
<li>将log中的key排序存放，在merge segment的时候就用mergesort即可快速合并，如果在多个segment中出现相同的key则保留最晚被修改的segment即可。</li>
<li>内存中hashmap只需要存一部分key的offset即可，快速定位到前后两个key之后查找即可。</li>
<li>在disk上维持sorted structure是可行的，如B-tree，但更方便的还是用in-memory的red-black tree或者AVL Tree，之后再写入logfile。<ol>
<li>每次写入都存入in-memory balanced tree structure（memtable）.</li>
<li>到达一定阈值后存入disk，这就是most recent segment。</li>
<li>读取时先尝试从in-memory读，没有再按照时间顺序从最近到最古老的logfile中查找。</li>
<li>时不时进行merging and compaction来取出重复的/删除了的key。</li>
<li>为了防止in-memory的宕机丢失，可以纯append到一个单独的file当中，不必维持顺序，宕机后重新读取再排序即可。</li>
</ol>
</li>
</ul>
<h4 id="B-Trees（最流行的index方式。）"><a href="#B-Trees（最流行的index方式。）" class="headerlink" title="B-Trees（最流行的index方式。）"></a>B-Trees（最流行的index方式。）</h4><ul>
<li>也需要维护排好序的key，不是将数据存到segment中，而是将数据拆分成固定大小（通常4KB左右）的disk blocks/pages，每个block通过地址来定位。每个block中存放key-value/addr，有点类似指针的概念，但不是内存而是disk。</li>
<li>查找是根据key，在某个范围内的需要跳转到某个地址查找，这样一路查找到leaf page就可以得到value或者存放的地址。branching factor通常是几百。</li>
<li>增加则是到leaf page直接加，如果该page剩余空间不足，则将它拆分成两个half full page，插入后更新parent page，加入一个key指向拆分出来的新page的头部。这一系列操作一旦崩了，就会丢失数据，因此需要额外的write-ahead log，一个append-only的存放所有修改操作的文件，方便恢复数据。</li>
<li>concurrency control: 需要latches(轻量级锁)来保证数据一致。</li>
</ul>
<h4 id="B-Tree-v-s-LSM-Trees"><a href="#B-Tree-v-s-LSM-Trees" class="headerlink" title="B-Tree v.s. LSM-Trees"></a>B-Tree v.s. LSM-Trees</h4><ul>
<li>LSM写入更快，B-Tree写入时由于WAL的存在需要写两次，如果涉及page split那就更复杂了。Log-structure由于merging和compaction也需要多次写数据，但这个write-amplification还是更快，因为是sequential的在disk上优势更大。</li>
<li>LSM产生的文件更小，B-Tree可能在page末尾有没用上的空间，LSM一波compaction能省很多空间。</li>
<li>LSM的compaction过程可能影响正常的读写速度，毕竟disk资源有限。</li>
<li>LSM的compaction可能跟不上正常写入的速度，这样disk会最终被占满，而读取也会变慢。</li>
<li>B-tree的一个优势是每个key只会在index中出现一次，这样可以保证强transaction.</li>
</ul>
<h4 id="Other-Index-Structures"><a href="#Other-Index-Structures" class="headerlink" title="Other Index Structures"></a>Other Index Structures</h4><ul>
<li>除了key-value这种primary index，很多时候还需要加secondary index，即允许重复的key对应不同的value。实现方式可以是将value存成list，或者将key加上id使其unique.</li>
<li>Heap file index: key指向一个heapfile，值统一存在heap中，每个index就指向heap中的一个位置即可。</li>
<li>clustered index: 将所有数据直接存储在index之内，而不只是一个reference。这样可以减少在heapfile中查找的时间。</li>
<li>covering index: 二者的结合，部分indexes cover了数据，其他的则还是需要到实际file中查找。</li>
<li>multi-column indexes: 同时查找多个keys。例如concatenated index就是将多个index拼接起来如(a-b-c),但无法高效查找b/c/b-c. 当然也可以将多维的转换为一维的再使用B-Tree，另外是更高级的multi-dimentional indexes如R-Tree. </li>
<li>full-text search and fuzzy indexes: 允许模糊搜索，不用完全和key吻合（拼错）或允许同义词。例如Lucene就允许搜索一定edit distance之内的词。</li>
<li>in-memory DB: Memcache本意是用来缓存的，但也可以作为DB，只需要提升durability通过在disk写changelog，或时不时往disk写snapshot，或replicate到其他机器。需要指出的是in-memory速度快主要不是来自于从内存中读数据，而是因为它避免了将数据encode成方便存入disk的结构。例如Redis可以存priorityQueue和set等。in-memoryDB可容纳数据的大小也可以超过物理内存，因为可以swap（系统的swap是以memory page为单位，这里的swap是以每一行record为单位）。</li>
<li>NVM: non-volatile memory，不需要swap也可以在内存里长久地存数据了。</li>
</ul>
<h3 id="Transaction-Processing-or-Analytics"><a href="#Transaction-Processing-or-Analytics" class="headerlink" title="Transaction Processing or Analytics?"></a>Transaction Processing or Analytics?</h3><p> transaction意思是a group of reads and writes that form a logical unit. 它并不需要保证ACID，只需要提供低延迟的读写。<br> | Property | Transaction processing systems(OLTP) | Analytic systems(OLAP) |<br> | :——-: | :——-: | :———-: |<br> |读|每次按照key来query少量数据|aggregate大量数据|<br> |写|random-access, 来自用户的低延迟写|Bulk import(ETL)或事件流|<br> |主要用于|用户通过web访问|内部数据分析，支持决策|<br> |数据表示的是|数据当前最新的状态|history of events over time|<br> |Dataset size|Gigabytes to Terabytes|Terabytes to Petabytes|</p>
<h4 id="Data-Warehousing"><a href="#Data-Warehousing" class="headerlink" title="Data Warehousing"></a>Data Warehousing</h4><ul>
<li>如果直接在OLTP数据库上进行数据分析，很可能会影响正常执行的来自用户的query。因此需要利用Extract-Transform-Load将数据转入独立的Data Warehouse后再做分析。</li>
<li>indexing对于OLTP数据库有很大帮助，但对于analytics不是很好。</li>
<li>DB vendors要么专注transaction processing，要么专注analytics workloads.</li>
<li>star schema: 将各个独立的table之间的关系visualize了。dim_table就是各个独立的表（who, where, when ,how, why），fact_table就集合了所有dim表的column，显示地表示数据之间的关系。</li>
</ul>
<h3 id="Column-Oriented-Storage"><a href="#Column-Oriented-Storage" class="headerlink" title="Column-Oriented Storage"></a>Column-Oriented Storage</h3><ul>
<li>通常fact表的列多大100+，行数达到trillions，因此在fact表上做query需要优化。</li>
<li>analytics中每次select用不到那么多列，通常只需要4～5列。</li>
<li>通常OLTP DB都是row-oriented，在不需要用到所有列的情况下还是会load很多无用的属性进内存，然后再根据WHERE筛选。因此可以存成column-oriented，这样可以减少很多不必要的load.</li>
<li>Column Compression: 每个column中所有的值可能有很多重复的，因此可以利用bitmap进行encoding，减少每一列需要存储的数据量。</li>
<li>vectorized processing: bandwidth瓶颈除了从disk载入内存外，还有内存到CPU cache. 为了充分利用CPU的cache，需要尽量让数据能fit到L1 cache里面。</li>
<li>写入column-oriented的DB不是很直接，例如B-Tree涉及compression就很可能需要将所有column files都重写一遍了。但LSM可以先存入内存，然后才写入diskfile，之后才会merge，这正是Vertica底层实现。</li>
</ul>
<h4 id="Sort-Order-in-Column-Storage"><a href="#Sort-Order-in-Column-Storage" class="headerlink" title="Sort Order in Column Storage"></a>Sort Order in Column Storage</h4><ul>
<li>根据query pattern选择对某些列进行排序。每次需要一整行地进行排序才能保证同一行的来自同一个entity。</li>
<li>sorted的好处是bitmap压缩时可以节省bit，因为可以保证相同的value排序后是相邻的。</li>
<li>在设置replica时可以将不同的sorted order存入不同的replica中，按需选择即可。</li>
</ul>
<h4 id="Materialize-Aggregation"><a href="#Materialize-Aggregation" class="headerlink" title="Materialize Aggregation"></a>Materialize Aggregation</h4><ul>
<li>data warehouse中很可能会反复调用相同的count/sum/avg/min/max，因此可以将这些常用的query缓存起来。</li>
<li>materialized view: 将常用结果存入独立的表中。OLTP中不常用，因为write-heavy，每次写都需要更新这些缓存的数据，速度慢。</li>
<li>data cube: 额外维护一些cell，每个cell存放特定column组合的aggregate数据，在这些cell上进行aggregate就快多了。</li>
</ul>
<h2 id="Chapter-4-Encoding-and-Evolution"><a href="#Chapter-4-Encoding-and-Evolution" class="headerlink" title="Chapter 4: Encoding and Evolution"></a>Chapter 4: Encoding and Evolution</h2><ul>
<li>系统总是在变化的，因此DB也难免需要更改schema。对于schema-on-write，DB有唯一指定的schema，可以通过migration(ALTER)实现；schema-on-read则涉及对代码的升级。</li>
<li>对于server-side应用，可以用rolling upgrade，将新代码部署到一个node上再逐步推广，防止全部down。对于client-side应用，就at the mercy of the user了，只能等客户自己更新。</li>
<li>由于可能同时存在新旧版本的代码/数据，需要注意backward compatibility（新代码可以读旧代码写入的数据）和forward compatibility（旧代码也能读新代码写入的数据）。</li>
</ul>
<h3 id="Formats-for-Encoding-Data"><a href="#Formats-for-Encoding-Data" class="headerlink" title="Formats for Encoding Data"></a>Formats for Encoding Data</h3><p> Encoding/Decoding指的是将数据在内存结构（objects/structs/lists/arrays/hashtables/trees）和传输存储结构（self-contained sequence of bytes）相互转换。</p>
<h4 id="Language-Specific-Formats"><a href="#Language-Specific-Formats" class="headerlink" title="Language-Specific Formats"></a>Language-Specific Formats</h4><p> 部分编程语言自带将in-memory object转成byte sequence的库，使用倒是非常方便，但弊端也很多，因此尽可能避免使用。</p>
<ul>
<li>生成出来的byte seq通常和语言绑定，无法简单地在另一个语言上decode。</li>
<li>decode的时候需要instantiate各种类，攻击者可能利用这个随机decode并执行随机代码。</li>
<li>versioning data也是问题，通常不支持compatibility.</li>
<li>效率不高，如CPU处理时间、生成的byte seq占据空间等。</li>
</ul>
<h4 id="JSON-XML-and-Binary-Variants"><a href="#JSON-XML-and-Binary-Variants" class="headerlink" title="JSON, XML and Binary Variants"></a>JSON, XML and Binary Variants</h4><ul>
<li>通常他们已经是不错的选择了，虽然仍有一些缺陷需要指出：<ul>
<li>encoding for numbers比较模糊，例如XML和CSV不区分数字和字符串，JSON不区分整数、小数，对于大数字支持不佳等。</li>
<li>JSON和XML支持unicode，但是不支持binary strings，往往需要转成Base64存入，这样占空间多了33%</li>
<li>XML和JSON可能需要在代码层面写死schema才能正确地读写。</li>
<li>CSV没有schema，但本身比较模糊，对于escape有正式的规定但很多库没有正确实现。</li>
</ul>
</li>
<li>Binary Encoding: JSON比XML更简介，但还是占用较多空间。JSON的binary encoding “MessagePack”利用byte头部规定后续的种类、长度，从而将JSON转换成binary encoding.</li>
<li>Thrift：Facebook发明的encode/decode库，定义schema，其中包含了tag、数据类型。<ul>
<li>BinaryProtocol：和MessagePack相比，无需在binary中重复存tag，只有tagNumber和数据类型。</li>
<li>CompactProtocol: 将数据类型和tagNumber压缩到一起</li>
</ul>
</li>
<li>Protocol Buffer: Google发明的encode/decode库，定义schema，其中包含了tag、数据类型。和Thrift CompactProtocol类似，将fieldType和tagNumber融合。</li>
<li>Field Tags Evolutions: 可以任意往schema中添加新的field，只是不能规定是required，因为旧代码也需要读懂新的schema。而只要有不重复的tagNumber，新代码也可以读懂旧代码写的数据。如果想删除field，则只能删除optional的，且不能再使用被删掉的tagNumber.</li>
<li>Datatypes Evolutions: 一定程度是允许的，但需要注意32-bit和64-bit只能是单向的转换，不能降低精度。</li>
<li>Avro: Apache发明的encode/decode库，定义schema，其中没有tagNumber，直接存域名、数据类型。encode后的binary直接是长度+内容的形式拼接而成，需要读写双方都按照约定的schema严格操作。<ul>
<li>读写双方的schema不用完全一致，只需要compatible即可。</li>
<li>schema evolution也是可行的，只是需要注意前后兼容性，只能添加或删除带有默认值的field。注意null在Avro中只有当它在union branch中才是合法的默认值。</li>
<li>reader如何知道writer的schema呢？毕竟在每一个record都附带schema很浪费空间。这就需要直冲Avro的应用场景了：(1) 大文件，含有大量records，就只需要一份schema; (2) 含有独立写入record的数据库，维护不同version的schema，按需读取; (3) 通过网络发送数据时可以在建立连接时就确定schema，之后的数据就按照该schema解读。</li>
<li>Dynamiccaly generated schemas: Avro对频繁更新的schema更友好，因为每次改变后只需要从DB export成Avro schema即可。而Thrift/ProtoBuf则需要手动改变DB -&gt; field tags的映射。</li>
<li>Code generation: 静态类型语言如Java/Cpp/C#都需要在读取数据时指明类型，但JS/Ruby/Python就不用。Thrift和ProtoBuf依赖于code generation，而Avro可以在不生成代码的情况下正常进行analyze.</li>
</ul>
</li>
</ul>
<h4 id="Modes-of-Dataflow"><a href="#Modes-of-Dataflow" class="headerlink" title="Modes of Dataflow"></a>Modes of Dataflow</h4><h5 id="Dataflow-Through-Databases"><a href="#Dataflow-Through-Databases" class="headerlink" title="Dataflow Through Databases"></a>Dataflow Through Databases</h5><ul>
<li>可以理解为sending a message to a future self，先写入，之后读出来，因此backward compatible很重要。另一方面如果rolling upgrade，新的代码写入而旧的代码需要读取，则需要考虑forward compatible.</li>
<li>数据可能在DB中存放很久，若更新schema，理论上可以全部重新写一遍，但更普遍的做法是在读的时候填充以前不存在的field，这样就变相允许schema evolution了。</li>
<li>Archival存储通常就直接用最新的schema dump到数据库，这样就包含了各种不同历史时期写入的数据了，用Avro进行分析比较合适。</li>
</ul>
<h5 id="Dataflow-Through-Services"><a href="#Dataflow-Through-Services" class="headerlink" title="Dataflow Through Services"></a>Dataflow Through Services</h5><ul>
<li>最常见的就是server-client结构了，通过API call进行数据交换。server本身也可以是client，这样就把一个复杂的系统decompose成独立的子系统，每个子系统可以独立维护、改变，这就是SOA/微服务架构。</li>
<li>REST: 思想是用url来辨认资源，并用HTTP的特性实现缓存管理、身份验证、内容类型交换等。</li>
<li>SOAP: 基于XML的一种规范，尽可能不依赖HTTP的特性而使用自身的<code>WS-*</code>特性。</li>
<li>RPC: remote procedure call本意是想让请求远程服务和调用本地函数一样方便。但缺陷很明显：<ul>
<li>本地函数调用要么成功要么失败，远程调用无法控制，因为牵扯网络问题，可能需要重发</li>
<li>本地函数调用要么返回结果、抛异常、或死循环毫无回应；而远程调用可能timeout无法回复，也可能request没发成功，无法知道原因</li>
<li>无脑重发请求也不科学，可能请求已经执行成功而回复丢失，并不需要重发</li>
<li>本地函数执行时间基本恒定，而远程调用牵扯的因素就多多了</li>
<li>本地调用时参数可以直接用索引、指针传，发送远程就要encode，复杂很多，占用空间也大</li>
<li>远程函数的实现可能是不同的语言，需要将参数翻译成对应的type才能执行</li>
</ul>
</li>
<li>进化版RPC: 承认远程调用与本地调用的区别，例如引入Futures/Promoises来实现asynchronized调用，可以并行调用多个远程服务。</li>
</ul>
<h5 id="Message-Passing-Dataflow"><a href="#Message-Passing-Dataflow" class="headerlink" title="Message-Passing Dataflow"></a>Message-Passing Dataflow</h5><ul>
<li>异步传送消息到一个中间的message broker/message queue中，由接收方从中读取，注意是单向的，要想回复就得走另一个中间件。这样比直接用RPC发送有以下好处<ul>
<li>中间件有buffer作用，防止接收方爆炸</li>
<li>自动重发，如果监测到crash</li>
<li>发送者不需要知道接受者的ip/端口</li>
<li>同一个消息可以同时发给多个接收方</li>
<li>解耦合：发送方只负责发，不需要关心谁consume.</li>
</ul>
</li>
<li>Message Broker: 一个进程发送到一个named queue/topic，broker确保这些信息最终会递送到consumers/subscribers处。如果需要，接收方可以chain一个另外的queue/topic进行回复。在queue中的通常就是byte和metadata，不是特定的data model.</li>
<li>Distributed Actors Framework: actor model用于单一进程的concurrency控制，逻辑不在thread level而是封装到了actor中。一个actor就是一个client/entity，通过发送消息和其他actors互动。若将服务分布到多个node上就形成了分布式actor，如果需要跨node就需要encode成byte sequence通过网络发送。这时候如果要保证前后兼容性和rolling upgrade，可能需要对框架做一些customize，例如替换掉内置的encode库。</li>
</ul>
<hr>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><ul>
<li><a href="https://www.amazon.com/Designing-Data-Intensive-Applications-Reliable-Maintainable/dp/1449373321" target="_blank" rel="external">Designing Data-Intensive Applications</a></li>
</ul>

      
    </div>

    

    
    
    

    

    
      
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>└(^o^)┘</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat.png" alt="Bob WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.png" alt="Bob Alipay"/>
        <p>Alipay</p>
      </div>
    

    
    <br>
    <div id="paypal-button">
      <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
        <input type="hidden" name="cmd" value="_donations" />
        <input type="hidden" name="business" value="XPMQMQD8XQUPL" />
        <input type="hidden" name="currency_code" value="USD" />
        <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
      </form>
    </div>

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/interview/" rel="tag"><i class="fa fa-tag"></i> interview</a>
          
            <a href="/tags/system/" rel="tag"><i class="fa fa-tag"></i> system</a>
          
            <a href="/tags/design/" rel="tag"><i class="fa fa-tag"></i> design</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div class="social_share">
            
            
               <div id="needsharebutton-postbottom">
                 <span class="btn">
                    <i class="fa fa-share-alt" aria-hidden="true"></i>
                 </span>
               </div>
            
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/11/01/sde_cultivation/" rel="next" title="码农的自我修养">
                <i class="fa fa-chevron-left"></i> 码农的自我修养
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/09/bq/" rel="prev" title="行为面试笔记">
                行为面试笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Bob"/>
            
              <p class="site-author-name" itemprop="name">Bob</p>
              <p class="site-description motion-element" itemprop="description">I'm a Software Engineer!</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">47</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">49</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-1-Relable-Scalable-and-Maintainable"><span class="nav-text">Chapter 1: Relable, Scalable and Maintainable</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Reliability"><span class="nav-text">Reliability</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Hardware-Faults"><span class="nav-text">Hardware Faults</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Software-Faults"><span class="nav-text">Software Faults</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Human-Errors"><span class="nav-text">Human Errors</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Scalability"><span class="nav-text">Scalability</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#如何衡量Load"><span class="nav-text">如何衡量Load</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#如何衡量Performance"><span class="nav-text">如何衡量Performance</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Maintainability"><span class="nav-text">Maintainability</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Operability"><span class="nav-text">Operability</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Simplicity"><span class="nav-text">Simplicity</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Evolvability"><span class="nav-text">Evolvability</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-2-Data-Models-and-Query-Languages"><span class="nav-text">Chapter 2: Data Models and Query Languages</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Relational-Model-v-s-Document-Model"><span class="nav-text">Relational Model v.s. Document Model</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SQL-NoSQL的优势劣势"><span class="nav-text">SQL/NoSQL的优势劣势</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Query-Language-for-Data"><span class="nav-text">Query Language for Data</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Graph-Like-Data-Models"><span class="nav-text">Graph-Like Data Models</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-3-Storage-and-Retrieval"><span class="nav-text">Chapter 3: Storage and Retrieval</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Data-Structures-in-Relational-DB"><span class="nav-text">Data Structures in Relational DB</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Hash-Indexes"><span class="nav-text">Hash Indexes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sorted-String-Tables-and-Log-Structured-Merge-Trees"><span class="nav-text">Sorted String Tables and Log-Structured Merge-Trees</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-Trees（最流行的index方式。）"><span class="nav-text">B-Trees（最流行的index方式。）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-Tree-v-s-LSM-Trees"><span class="nav-text">B-Tree v.s. LSM-Trees</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Other-Index-Structures"><span class="nav-text">Other Index Structures</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transaction-Processing-or-Analytics"><span class="nav-text">Transaction Processing or Analytics?</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Data-Warehousing"><span class="nav-text">Data Warehousing</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Column-Oriented-Storage"><span class="nav-text">Column-Oriented Storage</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Sort-Order-in-Column-Storage"><span class="nav-text">Sort Order in Column Storage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Materialize-Aggregation"><span class="nav-text">Materialize Aggregation</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-4-Encoding-and-Evolution"><span class="nav-text">Chapter 4: Encoding and Evolution</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Formats-for-Encoding-Data"><span class="nav-text">Formats for Encoding Data</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Language-Specific-Formats"><span class="nav-text">Language-Specific Formats</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JSON-XML-and-Binary-Variants"><span class="nav-text">JSON, XML and Binary Variants</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Modes-of-Dataflow"><span class="nav-text">Modes of Dataflow</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Dataflow-Through-Databases"><span class="nav-text">Dataflow Through Databases</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Dataflow-Through-Services"><span class="nav-text">Dataflow Through Services</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Message-Passing-Dataflow"><span class="nav-text">Message-Passing Dataflow</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#References"><span class="nav-text">References</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-futbol-o"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bob</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a></div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="Total Visitors">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="site-pv" title="Total Views">
      <i class="fa fa-history"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    

    

    

    
      <div>
        <!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_inline_share_toolbox">
  <script type = "text/javascript" src = "//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-593135f4e114024c" async = "async" ></script>
</div>

      </div>
    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>



  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  

  
    <script id="dsq-count-scr" src="https://bobbyliujb.disqus.com/count.js" async></script>
  

  
    <script>
      var disqus_config = function () {
        this.page.url = "https://bobbyliujb.github.io/2020/01/15/designing_data_intensive_app/";
        this.page.identifier = "2020/01/15/designing_data_intensive_app/";
        this.page.title = 'Design Data Intensive Applications读书笔记';
        };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://bobbyliujb.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script>
  













  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('10');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script>
    
    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function ({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', `/classes/Counter/${counter.objectId}`, JSON.stringify({ time: { "__op":"Increment", "amount":1 } }))
            
            .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.time + 1);
            })
            
            .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
            })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1}))
                .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function () {
                  console.log('Failed to create');
                });
            
          }
        })
      .fail(function ({ responseJSON }) {
        console.log('LeanCloud Counter Error:' + responseJSON.code + " " + responseJSON.error);
      });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "jT7i5auNazMHRONSPUHmcoko-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "jT7i5auNazMHRONSPUHmcoko-gzGzoHsz",
                'X-LC-Key': "dEWwuVre5Svmwvjw2DmcIbLy",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          addCount(Counter);
          
        })
    });
  </script>



  

  

  

  

  
  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>
  <script>
    
      pbOptions = {};
      
        pbOptions.iconStyle = "box";
      
        pbOptions.boxForm = "horizontal";
      
        pbOptions.position = "topCenter";
      
        pbOptions.networks = "Linkedin,Weibo,Wechat,Twitter,Facebook,Pinterest,GooglePlus,Evernote,Reddit,Douban,QQZone,Mailto";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>


  

  

  

  

  

  

  

</body>
</html>
